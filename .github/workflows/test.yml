name: Test Action

on:
  push:
    branches: [ main, copilot/** ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    name: Test Composer Installation
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        composer-version: ['latest', '2', '2.7.1', '2.6.6']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: none

      - name: Test CVM Action
        id: cvm
        uses: ./
        with:
          composer-version: ${{ matrix.composer-version }}

      - name: Verify Installation
        run: |
          echo "Testing Composer installation..."
          composer --version

          echo "Installed version: ${{ steps.cvm.outputs.composer-version }}"
          echo "Composer path: ${{ steps.cvm.outputs.composer-path }}"

          # Verify composer is executable
          if [ ! -x "${{ steps.cvm.outputs.composer-path }}" ]; then
            echo "Error: Composer is not executable"
            exit 1
          fi

          # Verify composer works
          composer --version || exit 1

          echo "âœ“ All tests passed!"
